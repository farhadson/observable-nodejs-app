# ğŸ“‹ REQUEST FLOW DOCUMENTATION

## Architecture Overview

```
.
â”œâ”€â”€ app.js
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ database.js
â”‚   â”œâ”€â”€ logging.js
â”‚   â”œâ”€â”€ metrics.js
â”‚   â””â”€â”€ tracing.js
â”œâ”€â”€ controllers
â”‚   â”œâ”€â”€ authController.js
â”‚   â”œâ”€â”€ chaosController.js
â”‚   â””â”€â”€ userController.js
â”œâ”€â”€ middleware
â”‚   â”œâ”€â”€ errorHandler.js
â”‚   â”œâ”€â”€ traceContext.js
â”‚   â””â”€â”€ validation.js
â”œâ”€â”€ models
â”‚   â””â”€â”€ userModel.js
â”œâ”€â”€ prisma
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â””â”€â”€ seed.js
â”œâ”€â”€ routes
â”‚   â”œâ”€â”€ authRoutes.js
â”‚   â”œâ”€â”€ chaosRoute.js
â”‚   â””â”€â”€ userRoutes.js
â”œâ”€â”€ server.js
â”œâ”€â”€ services
â”‚   â”œâ”€â”€ authService.js
â”‚   â”œâ”€â”€ chaosService.js
â”‚   â”œâ”€â”€ databaseService.js
â”‚   â””â”€â”€ userService.js
â””â”€â”€ validators
    â””â”€â”€ userValidator.js
```

---

## ğŸ”„ EXAMPLE 1: Create User Flow - POST /api/users

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT REQUEST                                                               â”‚
â”‚ curl -X POST http://localhost:3000/api/users \                              â”‚
â”‚   -H "Content-Type: application/json" \                                     â”‚
â”‚   -d '{"email":"john@example.com","password":"pass123","name":"John"}'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: HTTP Server Receives Request                                        â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: server.js                                                             â”‚
â”‚ Function: server.listen() callback                                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Node.js HTTP server accepts TCP connection                                â”‚
â”‚ â†’ Request enters Express application                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: OpenTelemetry Auto-Instrumentation (BEFORE app.js)                  â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: config/tracing.js                                                     â”‚
â”‚ Module: @opentelemetry/instrumentation-http (auto)                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Automatically wraps HTTP request                                          â”‚
â”‚ â†’ Creates root span: "POST /api/users"                                      â”‚
â”‚ â†’ Generates traceId: "a1b2c3d4e5f6..."                                      â”‚
â”‚ â†’ Generates spanId: "x1y2z3..."                                             â”‚
â”‚ â†’ Span starts timing                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Express Application Entry                                           â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Object: const app = express()                                               â”‚
â”‚                                                                              â”‚
â”‚ â†’ Express creates req and res objects                                       â”‚
â”‚ â†’ Starts middleware chain                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: JSON Body Parser Middleware                                         â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Middleware: express.json()                                                  â”‚
â”‚                                                                              â”‚
â”‚ â†’ Parses JSON from request body                                             â”‚
â”‚ â†’ Populates req.body = {                                                    â”‚
â”‚     email: "john@example.com",                                              â”‚
â”‚     password: "pass123",                                                    â”‚
â”‚     name: "John"                                                            â”‚
â”‚   }                                                                          â”‚
â”‚ â†’ Calls next()                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: URL-Encoded Parser Middleware                                       â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Middleware: express.urlencoded({ extended: true })                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Skips processing (Content-Type is application/json)                       â”‚
â”‚ â†’ Calls next()                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: Trace Context Middleware                                            â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: middleware/traceContext.js                                            â”‚
â”‚ Function: traceContextMiddleware(req, res, next)                            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Gets active span from OpenTelemetry context                               â”‚
â”‚   const span = trace.getSpan(context.active())                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ Extracts trace context:                                                   â”‚
â”‚   req.traceId = "a1b2c3d4e5f6..."                                           â”‚
â”‚   req.spanId = "x1y2z3..."                                                  â”‚
â”‚                                                                              â”‚
â”‚ â†’ Adds response header:                                                     â”‚
â”‚   res.setHeader('X-Trace-Id', 'a1b2c3d4e5f6...')                            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Calls next()                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: Metrics Middleware                                                  â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Middleware: app.use((req, res, next) => {...})                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ Records start time: const start = Date.now()                              â”‚
â”‚ â†’ Registers 'finish' event listener on response:                            â”‚
â”‚   res.on('finish', () => {                                                  â”‚
â”‚     const duration = (Date.now() - start) / 1000;                           â”‚
â”‚     recordHttpRequest(req.method, req.route?.path, res.statusCode, duration)â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Event fires LATER when response completes                                 â”‚
â”‚ â†’ Calls next()                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: Route Matching                                                      â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Route: app.use('/api/users', userRoutes)                                    â”‚
â”‚                                                                              â”‚
â”‚ â†’ Express matches "/api/users" prefix                                       â”‚
â”‚ â†’ Forwards to userRoutes router                                             â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚ File: routes/userRoutes.js                                                  â”‚
â”‚ Route: router.post('/', validate(createUserSchema), userController.create)  â”‚
â”‚                                                                              â”‚
â”‚ â†’ Matches POST method and "/" path (full path: /api/users/)                 â”‚
â”‚ â†’ Sets req.route.path = "/api/users"                                        â”‚
â”‚ â†’ Executes middleware chain: [validate(...), userController.create]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 9: Validation Middleware                                               â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: middleware/validation.js                                              â”‚
â”‚ Function: validate(createUserSchema) â†’ returns middleware function          â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚ File: validators/userValidator.js                                           â”‚
â”‚ Schema: createUserSchema (Joi.object)                                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ Merges validation data:                                                   â”‚
â”‚   const dataToValidate = { ...req.body, ...req.params, ...req.query }      â”‚
â”‚   // { email: "john@example.com", password: "pass123", name: "John" }      â”‚
â”‚                                                                              â”‚
â”‚ â†’ Validates against Joi schema:                                             â”‚
â”‚   const { error, value } = createUserSchema.validate(dataToValidate, {     â”‚
â”‚     abortEarly: false,                                                      â”‚
â”‚     stripUnknown: true                                                      â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ If error exists:                                                          â”‚
â”‚   - Logs: logger.warn('Validation failed', { errors })                      â”‚
â”‚   - Returns: res.status(400).json({ success: false, errors })               â”‚
â”‚   - STOPS HERE (does not call next())                                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ If validation passes:                                                     â”‚
â”‚   - Updates req.body with sanitized values                                  â”‚
â”‚   - Calls next() â†’ proceeds to controller                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 10: User Controller - Create Method                                    â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: controllers/userController.js                                         â”‚
â”‚ Class: UserController                                                       â”‚
â”‚ Method: async create(req, res, next)                                        â”‚
â”‚                                                                              â”‚
â”‚ â†’ Enters try block                                                          â”‚
â”‚ â†’ Calls service layer:                                                      â”‚
â”‚   const user = await userService.createUser(req.body)                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ Awaits response from service...                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 11: User Service - Create User Method                                  â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: services/userService.js                                               â”‚
â”‚ Class: UserService                                                          â”‚
â”‚ Method: async createUser(userData)                                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Gets OpenTelemetry tracer:                                                â”‚
â”‚   const tracer = trace.getTracer('user-service')                            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Starts active span (creates child span):                                  â”‚
â”‚   tracer.startActiveSpan('user.create', async (span) => {                   â”‚
â”‚     // Span hierarchy: HTTP request â†’ user.create                           â”‚
â”‚                                                                              â”‚
â”‚ â†’ Adds span attribute:                                                      â”‚
â”‚   span.setAttribute('user.email', 'john@example.com')                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ Destructures user data:                                                   â”‚
â”‚   const { email, password, name } = userData                                â”‚
â”‚                                                                              â”‚
â”‚ â†’ Calls auth service to hash password:                                      â”‚
â”‚   const hashedPassword = await authService.hashPassword(password)           â”‚
â”‚                                                                              â”‚
â”‚ â†’ Awaits auth service...                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 12: Auth Service - Hash Password Method                                â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: services/authService.js                                               â”‚
â”‚ Class: AuthService                                                          â”‚
â”‚ Method: async hashPassword(password)                                        â”‚
â”‚                                                                              â”‚
â”‚ â†’ Gets tracer:                                                              â”‚
â”‚   const tracer = trace.getTracer('auth-service')                            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Starts active span (creates child span):                                  â”‚
â”‚   tracer.startActiveSpan('auth.hashPassword', async (span) => {             â”‚
â”‚     // Span hierarchy: HTTP â†’ user.create â†’ auth.hashPassword               â”‚
â”‚                                                                              â”‚
â”‚ â†’ Hashes password using bcrypt:                                             â”‚
â”‚   const saltRounds = 10                                                     â”‚
â”‚   const hashed = await bcrypt.hash('pass123', saltRounds)                   â”‚
â”‚   // Returns: "$2b$10$X8f9..."                                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ Logs success:                                                             â”‚
â”‚   logger.info('Password hashed successfully')                               â”‚
â”‚   // Log includes traceId from context                                      â”‚
â”‚                                                                              â”‚
â”‚ â†’ Ends span: span.end()                                                     â”‚
â”‚ â†’ Returns hashed password to userService                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 13: Back to User Service - Call Model                                  â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: services/userService.js (continued)                                   â”‚
â”‚ Method: async createUser(userData) - still in span 'user.create'            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Received hashedPassword: "$2b$10$X8f9..."                                 â”‚
â”‚                                                                              â”‚
â”‚ â†’ Calls model layer:                                                        â”‚
â”‚   const user = await UserModel.create({                                     â”‚
â”‚     email: 'john@example.com',                                              â”‚
â”‚     password: '$2b$10$X8f9...',                                             â”‚
â”‚     name: 'John'                                                            â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Awaits model response...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 14: User Model - Create Method                                         â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: models/userModel.js                                                   â”‚
â”‚ Class: UserModel                                                            â”‚
â”‚ Method: async create(userData)                                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ Calls Prisma Client:                                                      â”‚
â”‚   const user = await prisma.user.create({                                   â”‚
â”‚     data: userData,                                                          â”‚
â”‚     select: {                                                                â”‚
â”‚       id: true,                                                              â”‚
â”‚       email: true,                                                           â”‚
â”‚       name: true,                                                            â”‚
â”‚       createdAt: true,                                                       â”‚
â”‚       updatedAt: true                                                        â”‚
â”‚     }                                                                        â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Prisma generates SQL query...                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 15: Prisma Client â†’ Database Query                                     â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ Module: @prisma/client (auto-generated)                                     â”‚
â”‚ Function: prisma.user.create()                                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ OpenTelemetry auto-instruments database query (creates child span)        â”‚
â”‚   Span name: "prisma:client:user.create"                                    â”‚
â”‚   Span hierarchy: HTTP â†’ user.create â†’ auth.hashPassword â†’ db.query         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Generates SQL:                                                            â”‚
â”‚   INSERT INTO "users" ("email", "password", "name")                         â”‚
â”‚   VALUES ('john@example.com', '$2b$10$X8f9...', 'John')                     â”‚
â”‚   RETURNING "id", "email", "name", "createdAt", "updatedAt";                â”‚
â”‚                                                                              â”‚
â”‚ â†’ Sends to PostgreSQL database via connection pool                          â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚ File: config/database.js                                                    â”‚
â”‚ Object: prisma (PrismaClient instance)                                      â”‚
â”‚                                                                              â”‚
â”‚ â†’ Uses Prisma connection                                                    â”‚
â”‚ â†’ Executes query on PostgreSQL                                              â”‚
â”‚ â†’ Database returns result:                                                  â”‚
â”‚   {                                                                          â”‚
â”‚     id: 1,                                                                   â”‚
â”‚     email: 'john@example.com',                                              â”‚
â”‚     name: 'John',                                                            â”‚
â”‚     createdAt: '2025-12-13T...',                                            â”‚
â”‚     updatedAt: '2025-12-13T...'                                             â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Prisma span ends                                                          â”‚
â”‚ â†’ Returns to UserModel                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 16: Response Flow - Model â†’ Service                                    â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: models/userModel.js                                                   â”‚
â”‚ Method: async create(userData) - returns user object                        â”‚
â”‚                                                                              â”‚
â”‚ â†’ Returns to service:                                                       â”‚
â”‚   return user                                                                â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚ File: services/userService.js                                               â”‚
â”‚ Method: async createUser(userData) - receives user object                   â”‚
â”‚                                                                              â”‚
â”‚ â†’ Logs success:                                                             â”‚
â”‚   logger.info('User created successfully', { userId: user.id })             â”‚
â”‚   // Output: "2025-12-13 10:30:45 [info] [TraceID: a1b2c3...] ..."         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Ends span: span.end() (in finally block)                                  â”‚
â”‚ â†’ Returns user to controller:                                               â”‚
â”‚   return user                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 17: Response Flow - Service â†’ Controller                               â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: controllers/userController.js                                         â”‚
â”‚ Method: async create(req, res, next) - receives user object                 â”‚
â”‚                                                                              â”‚
â”‚ â†’ Still in try block, after await                                           â”‚
â”‚ â†’ Has user object from service                                              â”‚
â”‚                                                                              â”‚
â”‚ â†’ Sends HTTP response:                                                      â”‚
â”‚   res.status(201).json({                                                    â”‚
â”‚     success: true,                                                           â”‚
â”‚     message: 'User created successfully',                                   â”‚
â”‚     data: user                                                               â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Response object sent to Express                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 18: Metrics Middleware - 'finish' Event Fires                          â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: app.js                                                                â”‚
â”‚ Event Listener: res.on('finish', () => {...})                               â”‚
â”‚                                                                              â”‚
â”‚ â†’ Response has been sent, now calculate metrics                             â”‚
â”‚ â†’ Calculate duration:                                                       â”‚
â”‚   const duration = (Date.now() - start) / 1000  // e.g., 0.125 seconds     â”‚
â”‚                                                                              â”‚
â”‚ â†’ Call metrics recording function:                                          â”‚
â”‚   recordHttpRequest(                                                        â”‚
â”‚     'POST',               // req.method                                     â”‚
â”‚     '/api/users',         // req.route.path                                 â”‚
â”‚     201,                  // res.statusCode                                 â”‚
â”‚     0.125                 // duration                                       â”‚
â”‚   )                                                                          â”‚
â”‚                                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                              â”‚
â”‚ File: config/metrics.js                                                     â”‚
â”‚ Function: recordHttpRequest(method, route, statusCode, duration)            â”‚
â”‚                                                                              â”‚
â”‚ â†’ Records OpenTelemetry metrics:                                            â”‚
â”‚   httpRequestCounter.add(1, {                                               â”‚
â”‚     method: 'POST',                                                          â”‚
â”‚     route: '/api/users',                                                    â”‚
â”‚     status_code: 201                                                         â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚   httpRequestDuration.record(0.125, {                                       â”‚
â”‚     method: 'POST',                                                          â”‚
â”‚     route: '/api/users',                                                    â”‚
â”‚     status_code: 201                                                         â”‚
â”‚   })                                                                         â”‚
â”‚                                                                              â”‚
â”‚ â†’ Gets current span for exemplar:                                           â”‚
â”‚   const span = trace.getSpan(context.active())                              â”‚
â”‚   const spanContext = span.spanContext()                                    â”‚
â”‚   exemplarLabels.traceId = 'a1b2c3d4e5f6...'                                â”‚
â”‚   exemplarLabels.spanId = 'x1y2z3...'                                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ Records Prometheus metric with exemplar (links metric to trace):          â”‚
â”‚   httpDurationHistogram.observe(                                            â”‚
â”‚     { method: 'POST', route: '/api/users', status_code: 201 },             â”‚
â”‚     0.125,                                                                   â”‚
â”‚     { traceId: 'a1b2c3d4e5f6...', spanId: 'x1y2z3...' }                     â”‚
â”‚   )                                                                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Metric now stored with link to trace!                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 19: OpenTelemetry - End Root Span & Export Trace                       â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: config/tracing.js                                                     â”‚
â”‚ Module: @opentelemetry/instrumentation-http (auto)                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ HTTP instrumentation detects response completion                          â”‚
â”‚ â†’ Ends root span: "POST /api/users"                                         â”‚
â”‚ â†’ Span includes all child spans:                                            â”‚
â”‚   â””â”€ POST /api/users (201ms)                                                â”‚
â”‚      â”œâ”€ user.create (180ms)                                                 â”‚
â”‚      â”‚  â”œâ”€ auth.hashPassword (120ms)                                        â”‚
â”‚      â”‚  â””â”€ prisma:client:user.create (55ms)                                 â”‚
â”‚      â””â”€ (metrics recording happens after)                                   â”‚
â”‚                                                                              â”‚
â”‚ â†’ Exports trace to Tempo:                                                   â”‚
â”‚   Object: traceExporter (OTLPTraceExporter)                                 â”‚
â”‚                                                                              â”‚
â”‚ â†’ Sends trace data to configured endpoint (HTTP or gRPC)                    â”‚
â”‚ â†’ Tempo stores trace for querying                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 20: HTTP Response Sent to Client                                       â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ File: server.js                                                             â”‚
â”‚ Object: server (HTTP server instance)                                       â”‚
â”‚                                                                              â”‚
â”‚ â†’ Sends HTTP response over TCP connection:                                  â”‚
â”‚                                                                              â”‚
â”‚   HTTP/1.1 201 Created                                                      â”‚
â”‚   Content-Type: application/json                                            â”‚
â”‚   X-Trace-Id: a1b2c3d4e5f6...                                               â”‚
â”‚                                                                              â”‚
â”‚   {                                                                          â”‚
â”‚     "success": true,                                                         â”‚
â”‚     "message": "User created successfully",                                 â”‚
â”‚     "data": {                                                                â”‚
â”‚       "id": 1,                                                               â”‚
â”‚       "email": "john@example.com",                                          â”‚
â”‚       "name": "John",                                                        â”‚
â”‚       "createdAt": "2025-12-13T07:00:00.000Z",                              â”‚
â”‚       "updatedAt": "2025-12-13T07:00:00.000Z"                               â”‚
â”‚     }                                                                        â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚ â†’ Client receives response                                                  â”‚
â”‚ â†’ Connection may be kept alive for subsequent requests                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ“Š What Happens in Parallel/Background

### Logging System

```
File: config/logging.js
Object: logger (Winston instance)

Throughout the request:
â†’ Every logger.info(), logger.warn(), logger.error() call:
  1. Gets current OpenTelemetry span context
  2. Adds traceId and spanId to log entry
  3. Writes to console (colorized)
  4. Writes to file: ./logs/app.log
  
Example log output:
2025-12-13 10:30:45 [info] [TraceID: a1b2c3d4e5f6...] [SpanID: x1y2z3...]: User created successfully {"userId":1}
```

### Prometheus Metrics Exposure

```
File: config/metrics.js
Object: prometheusExporter (PrometheusExporter instance)

Background HTTP server on port 9464:
â†’ Prometheus scrapes: http://localhost:9464/metrics
â†’ Returns all collected metrics in Prometheus format
â†’ Includes standard OpenTelemetry metrics

Custom metrics endpoint:
File: app.js
Route: app.get('/metrics-custom', ...)
â†’ Browser/curl accesses: http://localhost:3000/metrics-custom
â†’ Returns metrics with exemplars (trace links)
```

## ğŸš¨ Error Flow Examples

### What if validation fails?

```
STEP 9: Validation Middleware (ERROR CASE)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

File: middleware/validation.js
Function: validate(createUserSchema) middleware

â†’ Request body: { email: "invalid-email", password: "123" }

â†’ Joi validation fails:
  error.details = [
    { message: "Please provide a valid email address", path: ["email"] },
    { message: "Password must be at least 6 characters long", path: ["password"] }
  ]

â†’ Logs warning:
  logger.warn('Validation failed', { errors })

â†’ Sends response immediately:
  res.status(400).json({
    success: false,
    message: 'Validation failed',
    errors: [...]
  })

â†’ Does NOT call next()
â†’ Request stops here, never reaches controller
â†’ Metrics still recorded (400 status code)
â†’ Trace still exported to Tempo
```

### What if service throws error?

```
STEP 11: User Service (ERROR CASE)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

File: services/userService.js
Method: async createUser(userData)

â†’ Inside try block, database query fails:
  Prisma throws: "Unique constraint violation on email"

â†’ Service catch block:
  span.recordException(error)  // Records in trace
  logger.error('User creation failed', { error: error.message })
  throw error  // Re-throws to controller

â†“

STEP 10: Controller (ERROR CASE)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

File: controllers/userController.js
Method: async create(req, res, next)

â†’ Controller catch block receives error:
  catch (error) {
    if (error.code === '23505') {  // Prisma duplicate key error
      return res.status(409).json({
        success: false,
        message: 'Email already exists'
      })
    }
    next(error)  // Pass other errors to error handler
  }

If error.code === '23505':
  â†’ Handles gracefully, sends 409 response
  â†’ Request ends here

If other error:
  â†’ Calls next(error) â†’ goes to error handler

â†“

ERROR HANDLER MIDDLEWARE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

File: middleware/errorHandler.js
Function: errorHandler(err, req, res, next)

â†’ Gets current span:
  const span = trace.getSpan(context.active())
  span.recordException(err)
  span.setStatus({ code: 2, message: err.message })  // ERROR status

â†’ Logs error:
  logger.error('Application error', {
    error: err.message,
    stack: err.stack,
    path: req.path,
    method: req.method
  })

â†’ Determines status code:
  const statusCode = err.statusCode || err.status || 500

â†’ Sends error response:
  res.status(statusCode).json({
    success: false,
    message: err.message || 'Internal Server Error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  })

â†’ Trace exported with error status
â†’ Metrics recorded with 500 status code
```

## ğŸ”„ EXAMPLE 2: Login Flow - POST /api/auth/login

```
REQUEST: POST /api/auth/login
BODY: { "email": "john@example.com", "password": "pass123" }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLOW SUMMARY                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. HTTP Server (server.js)                                 â”‚
â”‚ 2. OpenTelemetry Auto-Instrumentation (config/tracing.js)  â”‚
â”‚ 3. Express App (app.js)                                    â”‚
â”‚ 4. JSON Parser (express.json)                              â”‚
â”‚ 5. Trace Context Middleware (middleware/traceContext.js)   â”‚
â”‚ 6. Metrics Middleware (app.js)                             â”‚
â”‚ 7. Route Matching:                                         â”‚
â”‚    app.js â†’ app.use('/api/auth', authRoutes)               â”‚
â”‚    routes/authRoutes.js â†’ router.post('/login', ...)       â”‚
â”‚ 8. Validation Middleware (middleware/validation.js)        â”‚
â”‚    Schema: validators/userValidator.js - loginSchema       â”‚
â”‚ 9. Auth Controller (controllers/authController.js)         â”‚
â”‚    Method: AuthController.login()                          â”‚
â”‚    â†’ Calls: userService.authenticateUser(email, password)  â”‚
â”‚10. User Service (services/userService.js)                  â”‚
â”‚    Method: UserService.authenticateUser()                  â”‚
â”‚    â†’ Starts span: 'user.authenticate'                      â”‚
â”‚    â†’ Calls: UserModel.findByEmail(email)                   â”‚
â”‚11. User Model (models/userModel.js)                        â”‚
â”‚    Method: UserModel.findByEmail()                         â”‚
â”‚    â†’ Calls: prisma.user.findUnique({ where: { email } })   â”‚
â”‚    â†’ Returns user WITH password                            â”‚
â”‚12. Back to User Service:                                   â”‚
â”‚    â†’ Calls: authService.comparePassword(password, hash)    â”‚
â”‚13. Auth Service (services/authService.js)                  â”‚
â”‚    Method: AuthService.comparePassword()                   â”‚
â”‚    â†’ Starts span: 'auth.comparePassword'                   â”‚
â”‚    â†’ Compares: bcrypt.compare(password, hashedPassword)    â”‚
â”‚    â†’ Returns boolean result                                â”‚
â”‚14. Back to User Service:                                   â”‚
â”‚    â†’ If invalid: returns null                              â”‚
â”‚    â†’ If valid: calls authService.generateToken(payload)    â”‚
â”‚15. Auth Service (services/authService.js)                  â”‚
â”‚    Method: AuthService.generateToken()                     â”‚
â”‚    â†’ Starts span: 'auth.generateToken'                     â”‚
â”‚    â†’ Generates: jwt.sign(payload, secret, { expiresIn })   â”‚
â”‚    â†’ Returns JWT token                                     â”‚
â”‚16. Back to User Service:                                   â”‚
â”‚    â†’ Removes password from user object                     â”‚
â”‚    â†’ Returns: { user: userWithoutPassword, token }         â”‚
â”‚17. Back to Auth Controller:                                â”‚
â”‚    â†’ Sends: res.status(200).json({ success, data })        â”‚
â”‚18. Metrics recorded and trace exported                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ EXAMPLE 3: Get All Users - GET /api/users

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLOW SUMMARY                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1-7. Same as above (HTTP â†’ Middleware â†’ Route Matching)    â”‚
â”‚ 8. Route: routes/userRoutes.js                             â”‚
â”‚    â†’ router.get('/', userController.getAll)                â”‚
â”‚ 9. User Controller (controllers/userController.js)         â”‚
â”‚    Method: UserController.getAll()                         â”‚
â”‚    â†’ Calls: userService.getAllUsers()                      â”‚
â”‚10. User Service (services/userService.js)                  â”‚
â”‚    Method: UserService.getAllUsers()                       â”‚
â”‚    â†’ Starts span: 'user.getAll'                            â”‚
â”‚    â†’ Calls: UserModel.findAll()                            â”‚
â”‚11. User Model (models/userModel.js)                        â”‚
â”‚    Method: UserModel.findAll()                             â”‚
â”‚    â†’ Calls: prisma.user.findMany({ select: {...} })        â”‚
â”‚    â†’ Returns array of users                                â”‚
â”‚12. Response: res.status(200).json({ success, data })       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ EXAMPLE 4: Update User - PUT /api/users/:id

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLOW SUMMARY                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1-7. Same as above                                          â”‚
â”‚ 8. Route: routes/userRoutes.js                             â”‚
â”‚    â†’ router.put('/:id', validate(updateUserSchema), ...)   â”‚
â”‚ 9. Validation: validates req.params.id and req.body        â”‚
â”‚10. User Controller (controllers/userController.js)         â”‚
â”‚    Method: UserController.update()                         â”‚
â”‚    â†’ Parses: parseInt(req.params.id)                       â”‚
â”‚    â†’ Calls: userService.updateUser(userId, req.body)       â”‚
â”‚11. User Service (services/userService.js)                  â”‚
â”‚    Method: UserService.updateUser()                        â”‚
â”‚    â†’ Starts span: 'user.update'                            â”‚
â”‚    â†’ Calls: UserModel.update(userId, updates)              â”‚
â”‚12. User Model (models/userModel.js)                        â”‚
â”‚    Method: UserModel.update()                              â”‚
â”‚    â†’ Calls: prisma.user.update({ where, data })            â”‚
â”‚    â†’ If not found: throws Prisma error code 'P2025'        â”‚
â”‚13. Service catches P2025 â†’ returns null                    â”‚
â”‚14. Controller:                                              â”‚
â”‚    â†’ If null: 404 response                                 â”‚
â”‚    â†’ If updated: 200 response with data                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ EXAMPLE 5: Delete User - DELETE /api/users/:id

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLOW SUMMARY                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1-7. Same as above                                          â”‚
â”‚ 8. Route: routes/userRoutes.js                             â”‚
â”‚    â†’ router.delete('/:id', userController.delete)          â”‚
â”‚ 9. User Controller (controllers/userController.js)         â”‚
â”‚    Method: UserController.delete()                         â”‚
â”‚    â†’ Parses: parseInt(req.params.id)                       â”‚
â”‚    â†’ Calls: userService.deleteUser(userId)                 â”‚
â”‚10. User Service (services/userService.js)                  â”‚
â”‚    Method: UserService.deleteUser()                        â”‚
â”‚    â†’ Starts span: 'user.delete'                            â”‚
â”‚    â†’ Calls: UserModel.delete(userId)                       â”‚
â”‚11. User Model (models/userModel.js)                        â”‚
â”‚    Method: UserModel.delete()                              â”‚
â”‚    â†’ Calls: prisma.user.delete({ where: { id } })          â”‚
â”‚    â†’ If not found: throws Prisma error code 'P2025'        â”‚
â”‚12. Service catches P2025 â†’ returns false                   â”‚
â”‚13. Controller:                                              â”‚
â”‚    â†’ If false: 404 response                                â”‚
â”‚    â†’ If true: 200 response                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Chaos Engineering Endpoints

| Route | Controller Method | Service Method |
|-------|------------------|----------------|
| `POST /api/chaos/latency` | `chaosController.js` - `configureLatency()` | `chaosService.js` - `configureLatency()` |
| `POST /api/chaos/random-failure` | `chaosController.js` - `configureRandomFailure()` | `chaosService.js` - `configureFailureRate()` |
| `POST /api/chaos/memory-leak` | `chaosController.js` - `triggerMemoryLeak()` | `chaosService.js` - `simulateMemoryLeak()` |
| `POST /api/chaos/cpu-spike` | `chaosController.js` - `triggerCPUSpike()` | `chaosService.js` - `simulateCPUSpike()` |
| `POST /api/chaos/database-error` | `chaosController.js` - `triggerDatabaseError()` | `chaosService.js` - `simulateDatabaseError()` |
| `GET /api/chaos/status` | `chaosController.js` - `getStatus()` | `chaosService.js` - `getStatus()` |
| `POST /api/chaos/disable-all` | `chaosController.js` - `disableAll()` | `chaosService.js` - `disableAllChaos()` |
| `POST /api/chaos/circuit-breaker-test` | `chaosController.js` - `circuitBreakerTest()` | Multiple `simulateDatabaseError()` calls |

## ğŸ“¦ Key Components Reference

### Configuration Files
- **config/database.js** - Prisma Client instance
- **config/logging.js** - Winston logger with OpenTelemetry
- **config/metrics.js** - Metrics functions: `recordHttpRequest()`, `recordDatabaseQuery()`
- **config/tracing.js** - OpenTelemetry setup with OTLP exporter

### Controllers (All in controllers/)
- **authController.js** - `AuthController.login()`
- **userController.js** - `UserController`: `create()`, `getAll()`, `getById()`, `update()`, `delete()`
- **chaosController.js** - `ChaosController`: chaos engineering methods

### Services (All in services/)
- **authService.js** - `AuthService`: `hashPassword()`, `comparePassword()`, `generateToken()`, `verifyToken()`
- **userService.js** - `UserService`: `createUser()`, `getUserById()`, `getAllUsers()`, `updateUser()`, `deleteUser()`, `authenticateUser()`
- **chaosService.js** - `ChaosService`: chaos engineering methods
- **databaseService.js** - `DatabaseService`: `query()`, `getClient()` (deprecated)

### Models (All in models/)
- **userModel.js** - `UserModel`: `findById()`, `findByEmail()`, `findAll()`, `create()`, `update()`, `delete()`

### Routes (All in routes/)
- **authRoutes.js** - `POST /login`
- **userRoutes.js** - `GET /`, `GET /:id`, `POST /`, `PUT /:id`, `DELETE /:id`
- **chaosRoute.js** - Chaos engineering routes

### Middleware (All in middleware/)
- **validation.js** - `validate(schema)` - Joi validation middleware factory
- **traceContext.js** - `traceContextMiddleware()` - Adds trace context to request
- **errorHandler.js** - `errorHandler()` - Global error handler

### Validators (All in validators/)
- **userValidator.js** - `createUserSchema`, `updateUserSchema`, `loginSchema`

## ğŸ¯ Key Patterns

### Tracing Pattern
```
const tracer = trace.getTracer('service-name');
return tracer.startActiveSpan('operation.name', async (span) => {
  try {
    span.setAttribute('key', 'value');
    // business logic
    return result;
  } catch (error) {
    span.recordException(error);
    throw error;
  } finally {
    span.end();
  }
});
```

### Error Handling Pattern
```
async method(req, res, next) {
  try {
    // call service
    // send response
  } catch (error) {
    next(error); // or handle specific errors
  }
}
```

### Logging Pattern
```
logger.info('message', { metadata });
// Output: [timestamp] [level] [TraceID: xxx] [SpanID: yyy]: message {...}
```